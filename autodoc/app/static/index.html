<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoDoc - Infrastructure Discovery</title>
  <style>
    :root {
      --bg: #1a1b26; --surface: #24283b; --surface2: #2f3346;
      --text: #c0caf5; --text-dim: #565f89; --accent: #7aa2f7;
      --green: #9ece6a; --red: #f7768e; --orange: #e0af68; --cyan: #7dcfff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .header { background: var(--surface); border-bottom: 1px solid var(--surface2); padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
    .header h1 { font-size: 20px; font-weight: 600; }
    .header h1 span { color: var(--accent); }
    .header .status { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-dim); }
    .header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .card { background: var(--surface); border-radius: 8px; border: 1px solid var(--surface2); }
    .card-header { padding: 16px; border-bottom: 1px solid var(--surface2); display: flex; align-items: center; justify-content: space-between; }
    .card-header h2 { font-size: 15px; font-weight: 600; }
    .card-body { padding: 16px; }
    .full-width { grid-column: 1 / -1; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; }
    .btn-primary { background: var(--accent); color: var(--bg); }
    .btn-primary:hover { opacity: 0.85; }
    .btn-sm { padding: 5px 12px; font-size: 12px; }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-success { background: var(--green); color: var(--bg); }
    .btn-outline { background: transparent; border: 1px solid var(--surface2); color: var(--text); }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--surface2);
      background: var(--bg); color: var(--text); font-size: 14px; font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .scan-card { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--surface2); }
    .scan-card:last-child { border-bottom: none; }
    .scan-info h3 { font-size: 14px; font-weight: 500; }
    .scan-info p { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
    .badge-ok { background: rgba(158,206,106,0.15); color: var(--green); }
    .badge-err { background: rgba(247,118,142,0.15); color: var(--red); }
    .badge-run { background: rgba(122,162,247,0.15); color: var(--accent); }
    .badge-idle { background: rgba(86,95,137,0.15); color: var(--text-dim); }
    .log { background: var(--bg); border-radius: 6px; padding: 12px; font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 12px; max-height: 300px; overflow-y: auto; line-height: 1.6; }
    .log .ts { color: var(--text-dim); }
    .log .ok { color: var(--green); }
    .log .err { color: var(--red); }
    .log .info { color: var(--cyan); }
    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--surface2); margin-bottom: 16px; }
    .tab { padding: 10px 20px; cursor: pointer; font-size: 13px; color: var(--text-dim); border-bottom: 2px solid transparent; transition: all 0.15s; }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab:hover { color: var(--text); }
    .hidden { display: none; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--surface2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; font-size: 13px; z-index: 100; animation: slideIn 0.3s ease; }
    .toast-ok { background: var(--green); color: var(--bg); }
    .toast-err { background: var(--red); color: #fff; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 8px 12px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-dim); border-bottom: 1px solid var(--surface2); }
    td { padding: 8px 12px; border-bottom: 1px solid var(--surface2); }
    tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1><span>AutoDoc</span> Infrastructure Discovery</h1>
    <div class="status"><div class="dot" id="health-dot"></div><span id="health-text">Connected</span></div>
  </div>

  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="scanners">Scanners</div>
      <div class="tab" data-tab="config">Configuration</div>
      <div class="tab" data-tab="results">Results</div>
      <div class="tab" data-tab="logs">Activity Log</div>
    </div>

    <!-- SCANNERS TAB -->
    <div id="tab-scanners">
      <div class="grid">
        <div class="card full-width">
          <div class="card-header">
            <h2>Scanner Controls</h2>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="runScan('all')">Run All Scans</button>
            </div>
          </div>
          <div class="card-body" style="padding:0">
            <div class="scan-card">
              <div class="scan-info">
                <h3>Docker Scanner</h3>
                <p>Discovers containers, networks, and volumes via Docker socket</p>
              </div>
              <div class="btn-group" style="align-items:center; gap:12px">
                <span class="badge badge-idle" id="status-docker">idle</span>
                <button class="btn btn-outline btn-sm" onclick="runScan('docker')">Run</button>
              </div>
            </div>
            <div class="scan-card">
              <div class="scan-info">
                <h3>Network Scanner</h3>
                <p>Subnet discovery via nmap (ping sweep + service detection)</p>
              </div>
              <div class="btn-group" style="align-items:center; gap:12px">
                <span class="badge badge-idle" id="status-network">idle</span>
                <button class="btn btn-outline btn-sm" onclick="runScan('network')">Run</button>
              </div>
            </div>
            <div class="scan-card">
              <div class="scan-info">
                <h3>ESXi Scanner</h3>
                <p>VMs, datastores, networking via SSH (RSA key auth)</p>
              </div>
              <div class="btn-group" style="align-items:center; gap:12px">
                <span class="badge badge-idle" id="status-esxi">idle</span>
                <button class="btn btn-outline btn-sm" onclick="runScan('esxi')">Run</button>
              </div>
            </div>
            <div class="scan-card">
              <div class="scan-info">
                <h3>Synology Scanner</h3>
                <p>Volumes, shares, packages via SSH (ed25519 key auth)</p>
              </div>
              <div class="btn-group" style="align-items:center; gap:12px">
                <span class="badge badge-idle" id="status-synology">idle</span>
                <button class="btn btn-outline btn-sm" onclick="runScan('synology')">Run</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h2>Scheduler</h2></div>
        <div class="card-body">
          <p style="font-size:13px; color:var(--text-dim); margin-bottom:12px" id="scheduler-info">Loading scheduler status...</p>
          <div class="btn-group">
            <button class="btn btn-outline btn-sm" onclick="loadScheduler()">Refresh Status</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CONFIG TAB -->
    <div id="tab-config" class="hidden">
      <div class="grid">
        <div class="card">
          <div class="card-header"><h2>Network Scanning</h2></div>
          <div class="card-body">
            <div class="form-group">
              <label>Subnets (comma-separated)</label>
              <input type="text" id="cfg-subnets" placeholder="192.168.1.0/24,10.10.0.0/24">
            </div>
            <div class="form-group">
              <label>Scan Interval (hours)</label>
              <input type="number" id="cfg-interval" min="1" max="168" value="24">
            </div>
            <button class="btn btn-primary btn-sm" onclick="saveConfig()">Save & Apply</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h2>SSH Targets</h2></div>
          <div class="card-body">
            <div class="form-group">
              <label>ESXi Host</label>
              <input type="text" id="cfg-esxi-host" placeholder="192.168.x.x">
            </div>
            <div class="form-group">
              <label>Synology Host</label>
              <input type="text" id="cfg-synology-host" placeholder="192.168.x.x">
            </div>
            <div class="form-group">
              <label>XWiki URL (internal)</label>
              <input type="text" id="cfg-xwiki-url" readonly>
            </div>
            <div class="form-group">
              <label>Ollama URL</label>
              <input type="text" id="cfg-ollama-url" readonly>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTS TAB -->
    <div id="tab-results" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>Last Scan Results</h2>
          <button class="btn btn-outline btn-sm" onclick="loadResults()">Refresh</button>
        </div>
        <div class="card-body" id="results-container">
          <p style="color:var(--text-dim); font-size:13px">Click "Refresh" to load results...</p>
        </div>
      </div>
    </div>

    <!-- LOGS TAB -->
    <div id="tab-logs" class="hidden">
      <div class="card">
        <div class="card-header">
          <h2>Activity Log</h2>
          <button class="btn btn-outline btn-sm" onclick="clearLog()">Clear</button>
        </div>
        <div class="card-body">
          <div class="log" id="log-output">
            <div><span class="ts">[--:--:--]</span> <span class="info">AutoDoc GUI loaded. Ready.</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const API = '';
let lastResults = {};

// Tabs
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    ['scanners','config','results','logs'].forEach(id => {
      document.getElementById('tab-'+id).classList.toggle('hidden', id !== t.dataset.tab);
    });
  });
});

function ts() { return new Date().toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

function log(msg, cls='info') {
  const el = document.getElementById('log-output');
  const div = document.createElement('div');
  div.innerHTML = `<span class="ts">[${ts()}]</span> <span class="${cls}">${msg}</span>`;
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function clearLog() { document.getElementById('log-output').innerHTML = ''; }

function toast(msg, ok=true) {
  const el = document.createElement('div');
  el.className = 'toast ' + (ok ? 'toast-ok' : 'toast-err');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function setBadge(scanner, state, text) {
  const el = document.getElementById('status-'+scanner);
  if (!el) return;
  el.className = 'badge badge-'+state;
  el.textContent = text || state;
}

async function runScan(type) {
  const scanners = type === 'all' ? ['docker','network','esxi','synology'] : [type];
  for (const s of scanners) setBadge(s, 'run', 'running...');
  log(`Starting ${type} scan...`);

  try {
    const resp = await fetch(API + '/api/scan/' + type, { method: 'POST' });
    const data = await resp.json();

    if (type === 'all') {
      for (const [k,v] of Object.entries(data)) {
        const ok = v.status === 'ok';
        setBadge(k, ok ? 'ok' : 'err', ok ? 'done' : 'error');
        log(`${k}: ${JSON.stringify(v)}`, ok ? 'ok' : 'err');
        lastResults[k] = v;
      }
    } else {
      const ok = data.status === 'ok';
      setBadge(type, ok ? 'ok' : 'err', ok ? 'done' : 'error');
      log(`${type}: ${JSON.stringify(data)}`, ok ? 'ok' : 'err');
      lastResults[type] = data;
    }
    toast(`${type} scan complete`);
  } catch (e) {
    for (const s of scanners) setBadge(s, 'err', 'error');
    log(`Scan error: ${e.message}`, 'err');
    toast(`Scan failed: ${e.message}`, false);
  }
}

async function loadConfig() {
  try {
    const resp = await fetch(API + '/api/config');
    const cfg = await resp.json();
    document.getElementById('cfg-subnets').value = cfg.scan_subnets || '';
    document.getElementById('cfg-interval').value = cfg.scan_interval_hours || 24;
    document.getElementById('cfg-esxi-host').value = cfg.esxi_host || '';
    document.getElementById('cfg-synology-host').value = cfg.synology_host || '';
    document.getElementById('cfg-xwiki-url').value = cfg.xwiki_url || '';
    document.getElementById('cfg-ollama-url').value = cfg.ollama_url || '';
  } catch(e) { log('Failed to load config: '+e.message, 'err'); }
}

async function saveConfig() {
  const cfg = {
    scan_subnets: document.getElementById('cfg-subnets').value,
    scan_interval_hours: parseInt(document.getElementById('cfg-interval').value),
    esxi_host: document.getElementById('cfg-esxi-host').value,
    synology_host: document.getElementById('cfg-synology-host').value,
  };
  try {
    const resp = await fetch(API + '/api/config', {
      method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(cfg)
    });
    const data = await resp.json();
    log('Config saved: ' + JSON.stringify(data), 'ok');
    toast('Configuration saved');
  } catch(e) {
    log('Failed to save config: '+e.message, 'err');
    toast('Save failed', false);
  }
}

async function loadScheduler() {
  try {
    const resp = await fetch(API + '/api/scheduler');
    const data = await resp.json();
    const el = document.getElementById('scheduler-info');
    if (data.running) {
      el.innerHTML = `<span style="color:var(--green)">Active</span> &mdash; Interval: <strong>${data.interval_hours}h</strong>, Next run: <strong>${data.next_run || 'pending'}</strong>`;
    } else {
      el.innerHTML = `<span style="color:var(--text-dim)">Inactive</span>`;
    }
  } catch(e) { log('Scheduler status error: '+e.message, 'err'); }
}

function loadResults() {
  const container = document.getElementById('results-container');
  if (Object.keys(lastResults).length === 0) {
    container.innerHTML = '<p style="color:var(--text-dim); font-size:13px">No scan results yet. Run a scan first.</p>';
    return;
  }
  let html = '<table><thead><tr><th>Scanner</th><th>Status</th><th>Details</th></tr></thead><tbody>';
  for (const [k,v] of Object.entries(lastResults)) {
    const ok = v.status === 'ok';
    const badge = ok ? '<span class="badge badge-ok">OK</span>' : '<span class="badge badge-err">Error</span>';
    const details = Object.entries(v).filter(([k2])=>k2!=='status').map(([k2,v2])=>`${k2}: ${v2}`).join(', ');
    html += `<tr><td><strong>${k}</strong></td><td>${badge}</td><td style="font-size:12px;color:var(--text-dim)">${details}</td></tr>`;
  }
  html += '</tbody></table>';
  container.innerHTML = html;
}

async function checkHealth() {
  try {
    const resp = await fetch(API + '/health');
    const data = await resp.json();
    document.getElementById('health-dot').style.background = 'var(--green)';
    document.getElementById('health-text').textContent = 'Connected';
  } catch(e) {
    document.getElementById('health-dot').style.background = 'var(--red)';
    document.getElementById('health-text').textContent = 'Disconnected';
  }
}

// Init
loadConfig();
loadScheduler();
checkHealth();
setInterval(checkHealth, 15000);
</script>
</body>
</html>
